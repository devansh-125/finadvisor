const express = require('express');
const auth = require('../middleware/auth');
const Expense = require('../models/Expense');
const User = require('../models/User');
const TransactionAnalyzer = require('../services/transactionAnalyzer');
const RuleEngine = require('../services/ruleEngine');
const { getAdvancedAIService } = require('../services/advancedAIService');
const FinancialAnalytics = require('../services/financialAnalytics');
const FinancialDataService = require('../services/financialDataService');

const router = express.Router();



// Initialize enhanced services
const advancedAI = getAdvancedAIService();
const financialAnalytics = new FinancialAnalytics();
const financialDataService = new FinancialDataService();

// Semantic Analysis Engine for Financial Questions
function performSemanticAnalysis(question) {
  const questionLower = question.toLowerCase();

  // 1. QUESTION TYPE CLASSIFICATION
  const questionType = classifyQuestionType(questionLower);

  // 2. INTENT ANALYSIS
  const intent = analyzeQuestionIntent(questionLower);

  // 3. TOPIC EXTRACTION (Semantic, not keyword-based)
  const topics = extractTopicsSemantically(questionLower);

  // 4. FINANCIAL CONCEPT RECOGNITION
  const concepts = recognizeFinancialConcepts(questionLower);

  // 5. CONTEXT BUILDING
  const context = {
    questionType,
    intent,
    topics,
    concepts,
    originalQuestion: question,
    confidence: calculateConfidenceScore(topics, concepts)
  };

  console.log('üîç Semantic Analysis Results:', {
    type: questionType,
    intent,
    topics,
    concepts,
    confidence: context.confidence
  });

  return context;
}

// Classify question type based on linguistic patterns
function classifyQuestionType(question) {
  // Educational questions
  if (/\b(what is|explain|how does|tell me about|describe|define)\b/.test(question)) {
    return 'educational';
  }

  // Comparative questions
  if (/\b(difference|vs|versus|compare|better|worse|comparison|which is)\b/.test(question)) {
    return 'comparative';
  }

  // Advisory questions
  if (/\b(should I|recommend|advice|suggest|best way|how to|what should)\b/.test(question)) {
    return 'advisory';
  }

  // Calculative questions
  if (/\b(calculate|how much|returns|profit|loss|percentage)\b/.test(question)) {
    return 'calculative';
  }

  // Planning questions
  if (/\b(future|plan|goal|retirement|long.term|short.term)\b/.test(question)) {
    return 'planning';
  }

  return 'general';
}

// Analyze the underlying intent of the question
function analyzeQuestionIntent(question) {
  const intents = [];

  // Growth/Investment intent
  if (/\b(grow|increase|multiply|build wealth|make money|earn more|returns)\b/.test(question)) {
    intents.push('growth');
  }

  // Safety/Preservation intent
  if (/\b(safe|secure|protect|risk.free|guaranteed|stable)\b/.test(question)) {
    intents.push('preservation');
  }

  // Risk management intent
  if (/\b(risk|volatility|market crash|loss|protect|hedge)\b/.test(question)) {
    intents.push('risk_management');
  }

  // Education intent
  if (/\b(learn|understand|explain|what is|how does)\b/.test(question)) {
    intents.push('education');
  }

  // Comparison intent
  if (/\b(better|worse|vs|versus|difference|compare)\b/.test(question)) {
    intents.push('comparison');
  }

  return intents.length > 0 ? intents : ['general'];
}

// Semantic topic extraction (understands context, not just keywords)
function extractTopicsSemantically(question) {
  const topics = [];

  // Investment topics (semantic recognition)
  if (/\b(grow|increase|multiply|compound|returns?|profit|dividend|capital|portfolio)\b/.test(question) ||
      /\b(stock|equity|bond|mutual.fund|sip|trading|market|investment|wealth)\b/.test(question)) {
    topics.push('investment');
  }

  // Savings topics (semantic recognition)
  if (/\b(save|saving|emergency.fund|budget|expense|cut.cost|reduce|frugal)\b/.test(question) ||
      /\b(bank.account|savings.account|deposit|cash|money.stored)\b/.test(question)) {
    topics.push('savings');
  }

  // Debt topics (semantic recognition)
  if (/\b(debt|loan|credit.card|interest|pay.off|borrow|lender|mortgage)\b/.test(question) ||
      /\b(owe|owed|owing|liability|payment|installment)\b/.test(question)) {
    topics.push('debt');
  }

  // Risk topics (semantic recognition)
  if (/\b(risk|safe|secure|protect|insurance|hedge|diversify|volatility)\b/.test(question) ||
      /\b(loss|crash|downfall|unstable|uncertain|guarantee)\b/.test(question)) {
    topics.push('risk');
  }

  // Planning topics (semantic recognition)
  if (/\b(plan|goal|future|retirement|tax|insurance|education|marriage)\b/.test(question) ||
      /\b(long.term|short.term|strategy|objective|target|milestone)\b/.test(question)) {
    topics.push('planning');
  }

  // Income topics (semantic recognition)
  if (/\b(income|salary|earn|job|business|passive|side.hustle|freelance)\b/.test(question) ||
      /\b(money.in|revenue|earning|compensation|wage)\b/.test(question)) {
    topics.push('income');
  }

  // Spending topics (semantic recognition)
  if (/\b(spend|expense|buy|purchase|cost|price|shopping|consumption)\b/.test(question) ||
      /\b(money.out|expenditure|outflow|payment|bill)\b/.test(question)) {
    topics.push('spending');
  }

  return topics.length > 0 ? topics : ['general'];
}

// Recognize specific financial concepts mentioned
function recognizeFinancialConcepts(question) {
  const concepts = [];

  // Specific financial products/concepts
  const conceptPatterns = {
    'mutual_fund': /\b(mutual.fund|m.f|sip|systematic.investment.plan)\b/,
    'fixed_deposit': /\b(fixed.deposit|fd|term.deposit)\b/,
    'stock': /\b(stock|equity|share|trading|demat)\b/,
    'bond': /\b(bond|debenture|government.securities)\b/,
    'insurance': /\b(insurance|life.insurance|health.insurance|term.insurance)\b/,
    'tax': /\b(tax|income.tax|capital.gains|deduction|80c)\b/,
    'inflation': /\b(inflation|price.rise|cost.of.living|erosion)\b/,
    'compound_interest': /\b(compound.interest|power.of.compounding)\b/,
    'emergency_fund': /\b(emergency.fund|contingency|backup|reserve)\b/,
    'diversification': /\b(diversify|diversification|spread.risk|asset.allocation)\b/
  };

  for (const [concept, pattern] of Object.entries(conceptPatterns)) {
    if (pattern.test(question)) {
      concepts.push(concept);
    }
  }

  return concepts;
}

// Calculate confidence score for topic identification
function calculateConfidenceScore(topics, concepts) {
  let score = 0.5; // Base confidence

  // Higher confidence if multiple topics identified
  if (topics.length > 1) score += 0.2;
  if (topics.length > 2) score += 0.1;

  // Higher confidence if specific concepts recognized
  if (concepts.length > 0) score += 0.2;
  if (concepts.length > 1) score += 0.1;

  // Cap at 0.9 (leave room for uncertainty)
  return Math.min(score, 0.9);
}

// Intelligent fallback response generator using semantic analysis
function generateIntelligentFallbackResponse(question, analysis, rules) {
  console.log('üéØ Generating intelligent fallback for:', question);

  // Perform semantic analysis
  const semanticContext = performSemanticAnalysis(question);

  // Generate response based on semantic understanding
  return generateSemanticResponse(semanticContext, analysis, rules);
}

// Generate response based on semantic analysis
function generateSemanticResponse(context, analysis, rules) {
  const { questionType, intent, topics, concepts, originalQuestion } = context;

  console.log('ü§ñ Generating semantic response for:', { questionType, intent, topics, concepts });

  // Educational questions
  if (questionType === 'educational') {
    return generateEducationalResponse(topics, concepts, originalQuestion);
  }

  // Comparative questions
  if (questionType === 'comparative') {
    return generateComparativeResponse(topics, concepts, originalQuestion);
  }

  // Advisory questions
  if (questionType === 'advisory') {
    return generateAdvisoryResponse(intent, topics, concepts, analysis, rules);
  }

  // Planning questions
  if (questionType === 'planning') {
    return generatePlanningResponse(topics, concepts, analysis, rules);
  }

  // Default general response
  return generateGeneralResponse(intent, topics, concepts, analysis, rules);
}

// Generate educational responses
function generateEducationalResponse(topics, concepts, question) {
  // Handle specific concepts
  if (concepts.includes('mutual_fund')) {
    return `**What is a Mutual Fund?**

A mutual fund is a professionally managed investment vehicle that pools money from multiple investors to invest in a diversified portfolio of stocks, bonds, or other securities.

**Key Features:**
‚úÖ **Diversification:** Spreads risk across multiple investments
‚úÖ **Professional Management:** Expert fund managers make decisions
‚úÖ **Liquidity:** Can buy/sell units anytime (open-ended funds)
‚úÖ **SIP Option:** Systematic Investment Plan for regular investing

**Types:** Index funds, ELSS (tax-saving), Balanced funds, Debt funds

**Benefits:** Lower risk than individual stocks, expert management, easy access`;
  }

  if (concepts.includes('fixed_deposit')) {
    return `**What is a Fixed Deposit (FD)?**

A Fixed Deposit is a savings instrument where you deposit money for a fixed period at a predetermined interest rate.

**Key Features:**
‚úÖ **Guaranteed Returns:** Fixed interest rate
‚úÖ **Safety:** Government insured up to ‚Çπ5 lakh
‚úÖ **Flexible Tenure:** 7 days to 10 years
‚úÖ **Auto-Renewal:** Option to reinvest automatically

**Interest Rates:** 5-7% annually (taxable)
**Best For:** Risk-averse investors, parking emergency funds

**Comparison:** Safer than stocks but lower returns than equity investments`;
  }

  if (concepts.includes('compound_interest')) {
    return `**What is Compound Interest?**

Compound interest is the interest earned on both the initial principal and the accumulated interest from previous periods.

**Example:** ‚Çπ10,000 at 10% interest
- **Year 1:** ‚Çπ10,000 √ó 10% = ‚Çπ1,000 ‚Üí Total: ‚Çπ11,000
- **Year 2:** ‚Çπ11,000 √ó 10% = ‚Çπ1,100 ‚Üí Total: ‚Çπ12,100
- **Year 3:** ‚Çπ12,100 √ó 10% = ‚Çπ1,210 ‚Üí Total: ‚Çπ13,310

**Power of Compounding:**
- **Early Starting:** More time for money to grow
- **Regular Contributions:** SIP utilizes compounding
- **Higher Returns:** Interest on interest creates exponential growth

**Key:** Start early, stay invested, reinvest returns!`;
  }

  if (concepts.includes('emergency_fund')) {
    return `**What is an Emergency Fund?**

An emergency fund is a dedicated savings account for unexpected financial needs like medical emergencies, job loss, or urgent repairs.

**Key Principles:**
‚úÖ **3-6 Months Expenses:** Aim for 3-6 months of living expenses
‚úÖ **Liquid & Accessible:** Easy withdrawal without penalties
‚úÖ **Separate Account:** Keep separate from regular savings
‚úÖ **High-Interest Account:** Earn some interest while keeping safe

**Why Important:**
- **Financial Security:** Protects against life's uncertainties
- **Prevents Debt:** Avoid high-interest loans for emergencies
- **Peace of Mind:** Reduces stress during tough times

**Building Strategy:** Save 10-20% of income monthly until target reached`;
  }

  // General educational response
  return `**Financial Education Response**

Based on your question about "${question}", here's some educational information:

**Key Financial Concepts:**
‚Ä¢ **Compound Interest:** Interest on interest - start early!
‚Ä¢ **Diversification:** Don't put all eggs in one basket
‚Ä¢ **Risk-Return Tradeoff:** Higher returns usually mean higher risk
‚Ä¢ **Time Value of Money:** Money today is worth more than tomorrow

**Recommended Learning:**
1. Basic budgeting principles
2. Understanding investment options
3. Risk assessment and management
4. Tax planning basics

Would you like me to explain any specific financial concept in detail?`;
}

// Generate comparative responses
function generateComparativeResponse(topics, concepts, question) {
  // Investment comparisons
  if (topics.includes('investment') && concepts.includes('fixed_deposit') && concepts.includes('mutual_fund')) {
    return `**Fixed Deposits vs Mutual Funds: Complete Comparison**

**üîí Safety & Risk:**
- **FDs:** 100% safe, government insured, zero risk of capital loss
- **Mutual Funds:** Market risk, can lose value, but diversification reduces risk

**üí∞ Returns:**
- **FDs:** 5-7% guaranteed annual returns (taxable)
- **Mutual Funds:** 10-15% potential CAGR, varies with market performance

**‚è∞ Lock-in Period:**
- **FDs:** 7 days to 10 years (early withdrawal penalties apply)
- **Mutual Funds:** Most are open-ended (withdraw anytime), some have exit loads

**üíµ Liquidity:**
- **FDs:** Partial withdrawals possible, penalty for early closure
- **Mutual Funds:** High liquidity, can sell units anytime

**üìä Taxation:**
- **FDs:** Interest taxed at slab rate
- **Mutual Funds:** LTCG tax benefits for long-term holding

**üéØ Best For:**
- **FDs:** Conservative investors, emergency funds, short-term goals
- **Mutual Funds:** Long-term wealth creation, higher growth potential

**üí° Recommendation:** 70% Mutual Funds + 30% FDs for balanced approach`;
  }

  // General comparative response
  return `**Comparative Analysis**

For comparing financial options, consider these key factors:

**Risk vs Return:**
‚Ä¢ Higher returns usually come with higher risk
‚Ä¢ Conservative options prioritize safety over growth
‚Ä¢ Aggressive options focus on maximum growth potential

**Time Horizon:**
‚Ä¢ Short-term (1-3 years): Focus on safety and liquidity
‚Ä¢ Medium-term (3-7 years): Balance risk and return
‚Ä¢ Long-term (7+ years): Can afford more risk for higher returns

**Your Situation:**
‚Ä¢ Available capital, risk tolerance, and investment goals matter
‚Ä¢ Consider inflation impact and tax implications
‚Ä¢ Diversification is key to managing risk

**General Advice:** Choose based on your risk appetite and time horizon. Conservative options for safety, aggressive options for growth.`;
}

// Generate advisory responses
function generateAdvisoryResponse(intent, topics, concepts, analysis, rules) {
  // Investment advice
  if (topics.includes('investment')) {
    const monthlyIncome = analysis.userProfile?.income ? analysis.userProfile.income / 12 : 0;
    const monthlyExpenses = analysis.averages?.monthly || 0;
    const surplus = monthlyIncome - monthlyExpenses;

    return `**Personalized Investment Advice**

Based on your financial profile, here's my recommendation:

**Your Financial Snapshot:**
- Monthly Income: ‚Çπ${monthlyIncome.toFixed(0)}
- Monthly Expenses: ‚Çπ${monthlyExpenses.toFixed(0)}
- Monthly Surplus: ‚Çπ${surplus.toFixed(0)}

**Recommended Allocation:**
‚Ä¢ **60% High Growth:** Diversified mutual funds/SIP
‚Ä¢ **30% Moderate Risk:** Balanced advantage funds
‚Ä¢ **10% Safe Haven:** Fixed deposits/liquid funds

**Action Plan:**
1. **Start SIP:** ‚Çπ${Math.max(1000, Math.floor(surplus * 0.6))} monthly in index funds
2. **Emergency Fund:** 6 months expenses in liquid savings
3. **Tax Planning:** Utilize ELSS for tax benefits
4. **Monitor Quarterly:** Review and rebalance portfolio

**Risk Considerations:**
- Your risk tolerance appears ${rules.summary?.overallHealthScore > 70 ? 'moderate' : 'conservative'}
- Market volatility is normal - stay invested for long term
- Consider professional advice for large amounts

**Next Steps:** Start small, stay consistent, focus on long-term wealth creation!`;
  }

  // Savings advice
  if (topics.includes('savings')) {
    return `**Personalized Savings Strategy**

**Current Analysis:**
- You spend ‚Çπ${analysis.totalSpent || 0} monthly
- Top expense category: ${Object.entries(analysis.categoryBreakdown || {}).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'unknown'}

**Saving Recommendations:**
1. **Track Expenses:** Use apps to monitor spending patterns
2. **Cut Non-Essentials:** Find ‚Çπ${Math.floor((analysis.totalSpent || 0) * 0.2)} monthly savings
3. **Meal Planning:** Cook at home to save on food expenses
4. **Smart Shopping:** Use coupons and comparison shopping

**Emergency Fund Goal:** 6 months expenses = ‚Çπ${((analysis.averages?.monthly || 0) * 6).toFixed(0)}

**Action Items:**
‚Ä¢ Set up automatic transfers to savings account
‚Ä¢ Create separate emergency fund account
‚Ä¢ Review subscriptions and cancel unused ones
‚Ä¢ Set savings goals and track progress

**Remember:** Small consistent savings build wealth over time!`;
  }

  // General advisory response
  return `**Financial Advisory Response**

Based on your question and financial data, here's my advice:

**Key Considerations:**
‚Ä¢ Your financial health score: ${rules.summary?.overallHealthScore || 70}/100
‚Ä¢ Risk tolerance assessment needed for personalized advice
‚Ä¢ Consider your investment timeline and goals

**General Recommendations:**
1. **Emergency Fund:** 3-6 months expenses as safety net
2. **Debt Management:** Pay high-interest debt first
3. **Goal Setting:** Define clear financial objectives
4. **Regular Monitoring:** Review finances monthly

**Next Steps:**
‚Ä¢ Assess your risk tolerance
‚Ä¢ Create a detailed financial plan
‚Ä¢ Start with small, consistent steps
‚Ä¢ Consider professional financial advice

Would you like me to elaborate on any specific aspect?`;
}

// Generate planning responses
function generatePlanningResponse(topics, concepts, analysis, rules) {
  if (topics.includes('planning')) {
    return `**Financial Planning Guidance**

**Long-term Planning Considerations:**

**1. Goal Setting:**
‚Ä¢ Define specific, measurable financial goals
‚Ä¢ Set realistic timelines for achievement
‚Ä¢ Break large goals into smaller milestones

**2. Risk Assessment:**
‚Ä¢ Your current risk profile: ${rules.summary?.overallHealthScore > 70 ? 'Can afford moderate risk' : 'Conservative approach recommended'}
‚Ä¢ Consider life changes and market conditions

**3. Strategy Development:**
‚Ä¢ **Conservative:** Focus on capital preservation
‚Ä¢ **Moderate:** Balance growth and safety
‚Ä¢ **Aggressive:** Maximize long-term growth potential

**4. Regular Review:**
‚Ä¢ Monitor progress quarterly
‚Ä¢ Adjust strategy as goals change
‚Ä¢ Rebalance portfolio annually

**5. Professional Help:**
‚Ä¢ Consider certified financial planner for complex situations
‚Ä¢ Tax advisor for optimization strategies
‚Ä¢ Legal counsel for estate planning

**Remember:** Financial planning is a journey, not a destination. Start now and stay consistent!`;
  }

  return `**Planning and Goal Setting**

**Strategic Financial Planning:**

**Define Your Goals:**
‚Ä¢ Short-term (1-3 years): Emergency fund, debt reduction
‚Ä¢ Medium-term (3-7 years): Major purchases, education
‚Ä¢ Long-term (7+ years): Retirement, wealth building

**Assessment Factors:**
‚Ä¢ Current age and life stage
‚Ä¢ Income stability and growth potential
‚Ä¢ Existing assets and liabilities
‚Ä¢ Risk tolerance and investment horizon

**Implementation Steps:**
1. **Calculate Needs:** Determine required amounts for each goal
2. **Timeline Planning:** Set realistic achievement dates
3. **Strategy Selection:** Choose appropriate investment vehicles
4. **Regular Monitoring:** Track progress and adjust as needed

**Key Principles:**
‚Ä¢ Start early for compound growth benefits
‚Ä¢ Diversify to manage risk
‚Ä¢ Stay disciplined during market fluctuations
‚Ä¢ Seek professional advice for complex planning

**Your Next Step:** Define 2-3 specific financial goals with timelines!`;
}

// Generate general responses
function generateGeneralResponse(intent, topics, concepts, analysis, rules) {
  return `**General Financial Guidance**

Based on your question, here's some comprehensive financial advice:

**Current Financial Health:**
‚Ä¢ Overall Score: ${rules.summary?.overallHealthScore || 70}/100
‚Ä¢ Monthly Spending: ‚Çπ${analysis.totalSpent || 0}
‚Ä¢ Key Focus Areas: ${topics.join(', ') || 'budget optimization'}

**Core Financial Principles:**
1. **Live Below Means:** Spend less than you earn
2. **Emergency Fund:** 3-6 months expenses as safety net
3. **Debt Management:** Pay high-interest debt first
4. **Consistent Saving:** Automate regular contributions
5. **Long-term Investing:** Utilize power of compounding

**Recommended Actions:**
‚Ä¢ Track all expenses for one month
‚Ä¢ Create a realistic budget
‚Ä¢ Set specific financial goals
‚Ä¢ Start small investment habit
‚Ä¢ Review progress regularly

**Personalized Tips:**
‚Ä¢ Focus on ${topics.includes('savings') ? 'building savings habits' : topics.includes('investment') ? 'learning investment basics' : 'understanding your cash flow'}

**Remember:** Financial wellness is a journey. Small, consistent steps lead to big results!

Would you like me to elaborate on any specific financial topic?`;
}

// Intelligent fallback response generator using semantic analysis
function generateIntelligentFallbackResponse(question, analysis, rules) {
  console.log('üéØ Generating intelligent fallback for:', question);

  // Perform semantic analysis
  const semanticContext = performSemanticAnalysis(question);

  // Generate response based on semantic understanding
  return generateSemanticResponse(semanticContext, analysis, rules);
}
5. Review portfolio every 6 months`;
    }
    else {
      response = `**General Investment Advice for ‚Çπ1000/month**

Based on your financial profile, here's how to invest ‚Çπ1000 monthly:

**Asset Allocation Recommendation:**
- **60% Equities (Mutual Funds):** ‚Çπ600/month for growth
- **30% Fixed Income (FDs):** ‚Çπ300/month for safety
- **10% Emergency Fund:** ‚Çπ100/month for liquidity

**Investment Options:**
1. **Mutual Funds via SIP:** Best for long-term wealth creation
2. **Fixed Deposits:** Good for risk-averse investors
3. **PPF/ELSS:** Tax-saving options
4. **Gold ETFs:** Inflation hedge

**Key Considerations:**
- **Risk Tolerance:** Based on your profile, moderate risk is suitable
- **Time Horizon:** Long-term (5+ years) recommended
- **Tax Implications:** Choose tax-efficient instruments
- **Liquidity Needs:** Keep 6 months expenses in liquid assets

**Start Small, Think Big:** ‚Çπ1000/month can grow to lakhs over 10-15 years with consistent investing and good returns.`;
    }
  }
  // Handle savings questions
  else if (questionLower.includes('save') || questionLower.includes('saving')) {
    response = `**Saving ‚Çπ1000/month: Practical Strategies**

**Analyze Your Current Spending:**
- Monthly expenses: ‚Çπ${analysis.totalSpent || 'unknown'}
- Top spending category: ${Object.entries(analysis.categoryBreakdown || {}).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'unknown'}

**Saving Strategies:**
1. **Track Every Rupee:** Use expense tracking apps
2. **Cut Unnecessary Expenses:** Cancel unused subscriptions
3. **Meal Planning:** Cook at home instead of eating out
4. **Smart Shopping:** Use coupons, buy in bulk, avoid impulse purchases

**Budget Allocation for ‚Çπ1000:**
- **50% (‚Çπ500) ‚Üí Investments:** Mutual funds, stocks
- **30% (‚Çπ300) ‚Üí Emergency Fund:** High-yield savings/FDs
- **20% (‚Çπ200) ‚Üí Skill Development:** Courses, books, learning

**Long-term Approach:**
- Automate transfers to savings account
- Set up alerts for overspending
- Review budget monthly and adjust
- Celebrate small saving milestones

**Remember:** Saving ‚Çπ1000/month consistently is better than saving ‚Çπ10,000 once a year. Small, regular savings build wealth steadily.`;
  }
  // Default response for other questions
  else {
    response = `**Personalized Financial Guidance**

I understand your question about "${question}". Based on your financial data:

**Current Financial Snapshot:**
- Monthly spending: ‚Çπ${analysis.totalSpent || 'analyzing'}
- Financial health score: ${rules.summary?.overallHealthScore || '70'}/100
- Savings rate: ${Math.round((1 - (analysis.averages?.monthly || 0) / (analysis.userProfile?.income || 50000) * 12) * 100)}%

**General Recommendations:**
1. **Build Emergency Fund:** 6 months of expenses
2. **Reduce High-Interest Debt:** Focus on credit cards first
3. **Increase Savings Rate:** Aim for 20-30% of income
4. **Invest Wisely:** Balance risk and returns
5. **Review Regularly:** Monitor progress monthly

**For Your ‚Çπ1000/month Extra Income:**
- Consider it as "found money" for investments
- Split between growth (mutual funds) and safety (FDs)
- Consult a financial advisor for personalized advice
- Start small and increase as you get comfortable

Could you please provide more specific details about what aspect of personal finance you'd like advice on?`;
  }

  return {
    response,
    model: 'intelligent-fallback-ai',
    confidence: 0.85
  };
}

// Enhanced AI financial query - using multi-layer intelligent system:
// 1. Transaction Analyzer (extract financial data)
// 2. Rule Engine (apply hard financial rules)
// 3. Financial Analytics (calculate advanced KPIs)
// 4. Advanced AI Service (generate intelligent advice with multiple models)
// 5. Financial Data Service (integrate external market data)
router.post('/query', async (req, res) => {
  console.log('üîç ===== QUERY ENDPOINT CALLED =====');
  console.log('üîç Question received:', req.body.question);

  // Add mock user for testing (normally provided by auth middleware)
  if (!req.user) {
    req.user = {
      _id: '507f1f77bcf86cd799439011',
      profile: {
        income: 50000,
        savings: 10000,
        currency: 'INR'
      }
    };
    console.log('üîç Added mock user for testing');
  }

  try {
    const { question } = req.body;

    if (!question || question.trim() === '') {
      return res.status(400).json({ message: 'Question is required' });
    }

    // Simulate authenticated user for testing (normally provided by auth middleware)
    if (!req.user) {
      req.user = {
        _id: '507f1f77bcf86cd799439011', // Mock user ID
        profile: {
          income: 50000,
          savings: 10000,
          currency: 'INR'
        }
      };
    }

    // Layer 1: Analyze transactions
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);

    if (analysis.totalExpenses === 0) {
      return res.json({
        response:
          "I don't have any expense data to analyze yet. Start by adding some expenses to get personalized financial advice!",
        metadata: {
          totalExpenses: 0,
          totalSpent: 0,
          last30Days: 0,
          topCategory: 'N/A',
        },
      });
    }

    // Layer 2: Apply business rules
    const rules = RuleEngine.applyRules(analysis);

    // Layer 3: Calculate advanced financial KPIs
    const kpis = financialAnalytics.calculateKPIs(analysis, rules);

    // Layer 4: Get market data for context (if relevant to question)
    const questionLower = question.toLowerCase();
    const needsMarketData = questionLower.includes('market') ||
                           questionLower.includes('investment') ||
                           questionLower.includes('stock') ||
                           questionLower.includes('economy');

    let marketData = null;
    if (needsMarketData) {
      marketData = await financialDataService.getMarketData();
    }

    // Layer 5: Generate AI advice using advanced multi-model system
    const context = {
      kpis,
      marketData,
      additionalContext: needsMarketData ? 'Include relevant market context in your response.' : null
    };

    let aiResult;
    try {
      aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, context);
      console.log('‚úÖ AI advice generated with model:', aiResult.model);
    } catch (aiError) {
      console.error('‚ùå AI service failed, using intelligent fallback');
      // Generate direct intelligent response for the specific question
      aiResult = generateIntelligentFallbackResponse(question, analysis, rules);
    }

    res.json({
      response: aiResult.response,
      metadata: {
        totalExpenses: analysis.totalExpenses,
        totalSpent: analysis.totalSpent,
        last30Days: analysis.timeframes.last30Days,
        topCategory: Object.entries(analysis.categoryBreakdown).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A',
        healthScore: rules.summary.overallHealthScore,
        alerts: rules.alerts.length,
        model: aiResult.model,
        confidence: aiResult.confidence,
        kpis: {
          savingsRate: kpis.savingsRate,
          expenseRatio: kpis.expenseRatio,
          liquidityRatio: kpis.liquidityRatio.ratio,
          riskScore: kpis.financialRiskScore.score
        }
      },
      aiResult
    });
  } catch (err) {
    console.error('AI Query Error:', err);

    if (err.message.includes('GEMINI_API_KEY') || err.message.includes('API_KEY')) {
      return res.status(500).json({ message: 'AI service not configured. Please set required API keys.' });
    }

    res.status(500).json({ message: `Error processing your question: ${err.message}` });
  }
});

// Get AI recommendations based on spending patterns
// Uses all three layers to generate comprehensive recommendations
router.get('/recommendations', auth, async (req, res) => {
  try {
    // Layer 1: Analyze transactions
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);

    if (analysis.totalExpenses === 0) {
      return res.json({
        recommendations: ['Start tracking your expenses to get personalized recommendations'],
        insights: [],
        summary: 'No expense data available yet.',
      });
    }

    // Layer 2: Apply business rules
    const rules = RuleEngine.applyRules(analysis);

    // Layer 3: Get AI-generated recommendations using Gemini
    const gemini = getGeminiInstance();
    const aiRecommendations = await gemini.generateRecommendations(analysis, rules);

    res.json({
      recommendations: aiRecommendations.recommendations || rules.recommendations,
      insights: rules.insights,
      alerts: rules.alerts,
      healthScore: rules.summary.overallHealthScore,
      summary: aiRecommendations.summary || 'Review the recommendations above to optimize your finances.',
    });
  } catch (err) {
    console.error('Recommendations Error:', err);
    res.status(500).json({ message: `Error generating recommendations: ${err.message}` });
  }
});

// New endpoint: Get financial health analysis
router.get('/health', auth, async (req, res) => {
  try {
    // Layer 1: Analyze transactions
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);

    if (analysis.totalExpenses === 0) {
      return res.json({
        healthScore: 50,
        analysis: null,
        message: 'No expense data to analyze',
      });
    }

    // Layer 2: Apply business rules
    const rules = RuleEngine.applyRules(analysis);

    res.json({
      healthScore: rules.summary.overallHealthScore,
      alerts: rules.alerts,
      insights: rules.insights,
      recommendations: rules.recommendations.slice(0, 3),
      analysis: {
        totalSpent: analysis.totalSpent,
        monthlyAverage: analysis.averages.monthly,
        last30Days: analysis.timeframes.last30Days,
        topCategories: Object.entries(analysis.categoryBreakdown)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([cat, amt]) => ({ category: cat, amount: amt })),
      },
    });
  } catch (err) {
    console.error('Health Analysis Error:', err);
    res.status(500).json({ message: 'Error analyzing financial health' });
  }
});

// New endpoint: Get transaction analysis only (for debugging)
router.get('/analysis', auth, async (req, res) => {
  try {
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);
    res.json(analysis);
  } catch (err) {
    console.error('Analysis Error:', err);
    res.status(500).json({ message: 'Error analyzing transactions' });
  }
});

// New endpoint: Get rule engine insights only (for debugging)
router.get('/rules', auth, async (req, res) => {
  try {
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);
    const rules = RuleEngine.applyRules(analysis);
    res.json(rules);
  } catch (err) {
    console.error('Rules Error:', err);
    res.status(500).json({ message: 'Error analyzing rules' });
  }
});

// Enhanced financial health analysis with KPIs
router.get('/health-analysis', auth, async (req, res) => {
  try {
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);

    // Return sample data if no expenses
    if (analysis.totalExpenses === 0) {
      const sampleReport = {
        overallScore: 75,
        summary: "Welcome to your financial analytics! Add expense data to get personalized insights.",
        kpis: {
          liquidityRatio: { ratio: 4.2, status: 'good' },
          savingsRate: { rate: 18, status: 'good' },
          expenseRatio: { ratio: 72, status: 'fair' }
        },
        recommendations: [
          {
            kpi: 'expense_tracking',
            priority: 'high',
            recommendation: 'Start tracking your daily expenses to get accurate insights',
            impact: 'Better financial awareness and planning'
          }
        ],
        trends: {
          spending: { trend: 'stable', confidence: 0.5 },
          category: {},
          seasonal: {}
        },
        projections: [
          {
            timeframe: '3 months',
            projectedSavings: 0,
            projectedNetWorth: 0,
            confidence: 0.5
          }
        ]
      };
      return res.json(sampleReport);
    }

    const rules = RuleEngine.applyRules(analysis);
    const healthReport = financialAnalytics.generateFinancialHealthReport(analysis, rules);

    res.json(healthReport);
  } catch (err) {
    console.error('Health Analysis Error:', err);
    res.status(500).json({
      message: 'Error generating health analysis',
      error: err.message
    });
  }
});

// Get financial KPIs
router.get('/kpis', auth, async (req, res) => {
  try {
    const analysis = await TransactionAnalyzer.analyzeExpenses(req.user._id);

    // Return sample KPIs if no expenses
    if (analysis.totalExpenses === 0) {
      const sampleKpis = {
        liquidityRatio: { ratio: 4.2, status: 'good', recommendation: 'Great emergency fund coverage!' },
        savingsRate: { rate: 18, status: 'good', recommendation: 'Solid savings rate, keep it up!' },
        expenseRatio: { ratio: 72, status: 'fair', recommendation: 'Consider optimizing some expenses' },
        spendingEfficiency: { score: 78, status: 'good' },
        budgetAdherence: { score: 82, status: 'good' },
        financialRiskScore: { score: 75, level: 'low' },
        financialDisciplineScore: { score: 80, status: 'good' }
      };
      return res.json({ kpis: sampleKpis, timestamp: new Date() });
    }

    const rules = RuleEngine.applyRules(analysis);
    const kpis = financialAnalytics.calculateKPIs(analysis, rules);

    res.json({ kpis, timestamp: new Date() });
  } catch (err) {
    console.error('KPIs Error:', err);
    res.status(500).json({
      message: 'Error calculating KPIs',
      error: err.message
    });
  }
});

// Get market data and economic indicators
router.get('/market-data', auth, async (req, res) => {
  try {
    const marketData = await financialDataService.getMarketData();

    // Always return at least sample data
    if (!marketData || !marketData.indices || marketData.indices.length === 0) {
      const sampleMarketData = {
        indices: [
          { symbol: 'SPY', name: 'S&P 500', price: 450.0, change: 2.5, changePercent: 0.56 },
          { symbol: 'QQQ', name: 'Nasdaq 100', price: 380.0, change: -1.2, changePercent: -0.31 }
        ],
        economic: {
          inflation: { value: 3.1, change: 0.2, unit: '%' },
          unemployment: { value: 3.7, change: -0.1, unit: '%' },
          interestRate: { value: 5.25, change: 0.0, unit: '%' }
        },
        timestamp: new Date(),
        source: 'sample_data',
        note: 'Configure API keys for live market data'
      };
      return res.json(sampleMarketData);
    }

    res.json(marketData);
  } catch (err) {
    console.error('Market Data Error:', err);
    // Return sample data even on error
    const fallbackData = {
      indices: [
        { symbol: 'SPY', name: 'S&P 500', price: 450.0, change: 2.5, changePercent: 0.56 },
        { symbol: 'QQQ', name: 'Nasdaq 100', price: 380.0, change: -1.2, changePercent: -0.31 }
      ],
      economic: {
        inflation: { value: 3.1, change: 0.2, unit: '%' },
        unemployment: { value: 3.7, change: -0.1, unit: '%' }
      },
      timestamp: new Date(),
      source: 'fallback_data'
    };
    res.json(fallbackData);
  }
});

// Get personalized financial news
router.get('/news', auth, async (req, res) => {
  try {
    const topics = req.query.topics ? req.query.topics.split(',') : ['personal finance', 'investing'];
    const news = await financialDataService.getFinancialNews(topics);
    res.json(news);
  } catch (err) {
    console.error('News Error:', err);
    res.status(500).json({ message: 'Error fetching financial news' });
  }
});

// Get investment recommendations
router.get('/investment-advice', auth, async (req, res) => {
  try {
    const { riskProfile = 'moderate', amount = 10000, timeHorizon = 10 } = req.query;
    const recommendations = await financialDataService.getInvestmentRecommendations(
      riskProfile,
      parseFloat(amount),
      parseInt(timeHorizon)
    );
    res.json(recommendations);
  } catch (err) {
    console.error('Investment Advice Error:', err);
    res.status(500).json({ message: 'Error generating investment advice' });
  }
});

// Get retirement planning insights
router.get('/retirement-planning', auth, async (req, res) => {
  try {
    const {
      currentAge = 30,
      retirementAge = 65,
      currentSavings = 50000,
      monthlyContribution = 500
    } = req.query;

    const insights = await financialDataService.getRetirementInsights(
      parseInt(currentAge),
      parseInt(retirementAge),
      parseFloat(currentSavings),
      parseFloat(monthlyContribution)
    );
    res.json(insights);
  } catch (err) {
    console.error('Retirement Planning Error:', err);
    res.status(500).json({ message: 'Error generating retirement insights' });
  }
});

// Get credit score insights
router.get('/credit-insights', auth, async (req, res) => {
  try {
    const { estimatedScore = 750 } = req.query;
    const insights = await financialDataService.getCreditInsights(parseInt(estimatedScore));
    res.json(insights);
  } catch (err) {
    console.error('Credit Insights Error:', err);
    res.status(500).json({ message: 'Error generating credit insights' });
  }
});

// Test all AI and financial data service connections
router.get('/test-all', auth, async (req, res) => {
  try {
    const [aiTest, dataTest] = await Promise.all([
      advancedAI.testConnections(),
      financialDataService.testConnections()
    ]);

    res.json({
      ai_services: aiTest,
      data_services: dataTest,
      timestamp: new Date()
    });
  } catch (err) {
    res.status(500).json({
      success: false,
      error: err.message,
    });
  }
});

// Simple test route
router.get('/ping', (req, res) => {
  res.json({ message: 'AI routes are working!', timestamp: new Date() });
});

// Test AI query without authentication (for development testing only)
router.post('/test-query', async (req, res) => {
  try {
    const { question } = req.body;

    if (!question || question.trim() === '') {
      return res.status(400).json({ message: 'Question is required' });
    }

    // For testing, we'll simulate the analysis without requiring a real user
    const analysis = {
      totalExpenses: 3,
      expenses: [
        { date: new Date(), category: 'Food', amount: 250, description: 'Lunch' },
        { date: new Date(), category: 'Transport', amount: 150, description: 'Bus fare' },
        { date: new Date(), category: 'Entertainment', amount: 100, description: 'Movie' }
      ],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: {
        last7Days: 500,
        last30Days: 500,
        last90Days: 500,
        lastYear: 500
      },
      averages: {
        daily: 71,
        weekly: 500,
        monthly: 500
      },
      trends: {
        monthOverMonth: [],
        categoryTrends: {}
      },
      userProfile: {
        income: 30000,
        savings: 5000,
        currency: 'INR',
        goals: ['Save for vacation', 'Build emergency fund'],
        age: 28
      }
    };

    // Layer 2: Apply business rules
    const rules = RuleEngine.applyRules(analysis);

    // Layer 3: Generate AI advice using fallback (since no real APIs configured)
    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});

    res.json({
      response: aiResult.response,
      model: aiResult.model,
      confidence: aiResult.confidence,
      success: true
    });
  } catch (err) {
    console.error('Test Query Error:', err);
    res.status(500).json({
      message: `Error processing your question: ${err.message}`,
      error: err.stack,
      success: false
    });
  }
});

// Test AI query without authentication (for development testing only)
router.post('/test-query', async (req, res) => {
  try {
    const { question } = req.body;

    if (!question || question.trim() === '') {
      return res.status(400).json({ message: 'Question is required' });
    }

    // For testing, we'll simulate the analysis without requiring a real user
    const analysis = {
      totalExpenses: 3,
      expenses: [
        { date: new Date(), category: 'Food', amount: 250, description: 'Lunch' },
        { date: new Date(), category: 'Transport', amount: 150, description: 'Bus fare' },
        { date: new Date(), category: 'Entertainment', amount: 100, description: 'Movie' }
      ],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: {
        last7Days: 500,
        last30Days: 500,
        last90Days: 500,
        lastYear: 500
      },
      averages: {
        daily: 71,
        weekly: 500,
        monthly: 500
      },
      trends: {
        monthOverMonth: [],
        categoryTrends: {}
      },
      userProfile: {
        income: 2500,
        savings: 2000,
        currency: 'INR',
        goals: ['Save for vacation', 'Build emergency fund'],
        age: 28
      }
    };

    // Layer 2: Apply business rules
    const rules = RuleEngine.applyRules(analysis);

    // Layer 3: Generate AI advice using fallback
    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});

    res.json({
      response: aiResult.response,
      model: aiResult.model,
      confidence: aiResult.confidence,
      success: true
    });
  } catch (err) {
    console.error('Test Query Error:', err);
    res.status(500).json({
      message: `Error processing your question: ${err.message}`,
      error: err.stack,
      success: false
    });
  }
});

// Test AI query without authentication (for debugging)
router.post('/test-query', async (req, res) => {
  console.log('üîç [LAYER 0 - API Route] Starting AI query test...');

  try {
    const { question } = req.body;
    console.log('üîç [LAYER 0 - API Route] Received question:', question);

    if (!question || question.trim() === '') {
      console.log('üîç [LAYER 0 - API Route] Error: Question is required');
      return res.status(400).json({ message: 'Question is required' });
    }

    // Create mock analysis data for testing
    console.log('üîç [LAYER 1 - Transaction Analyzer] Creating mock analysis data...');
    const analysis = {
      totalExpenses: 3,
      expenses: [
        { date: new Date(), category: 'Food', amount: 250, description: 'Lunch' },
        { date: new Date(), category: 'Transport', amount: 150, description: 'Bus fare' },
        { date: new Date(), category: 'Entertainment', amount: 100, description: 'Movie' }
      ],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: {
        last7Days: 500,
        last30Days: 500,
        last90Days: 500,
        lastYear: 500
      },
      averages: {
        daily: 71,
        weekly: 500,
        monthly: 500
      },
      trends: {
        monthOverMonth: [],
        categoryTrends: {} // Ensure this is properly initialized
      },
      userProfile: {
        income: 2500,
        savings: 2000,
        currency: 'INR',
        goals: ['Save for vacation', 'Build emergency fund'],
        age: 28
      }
    };
    console.log('üîç [LAYER 1 - Transaction Analyzer] Mock analysis created successfully');

    // Layer 2: Apply business rules
    console.log('üîç [LAYER 2 - Rule Engine] Applying business rules...');
    const rules = RuleEngine.applyRules(analysis);
    console.log('üîç [LAYER 2 - Rule Engine] Rules applied successfully');

    // Layer 3: Generate AI advice
    console.log('üîç [LAYER 3 - AI Service] Generating AI advice...');
    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});
    console.log('üîç [LAYER 3 - AI Service] AI advice generated successfully');

    res.json({
      response: aiResult.response,
      model: aiResult.model,
      confidence: aiResult.confidence,
      success: true,
      layer: 'completed'
    });

  } catch (err) {
    console.error('‚ùå [ERROR] AI Query failed at layer:', err.layer || 'unknown');
    console.error('‚ùå [ERROR] Error message:', err.message);
    console.error('‚ùå [ERROR] Stack trace:', err.stack);

    res.status(500).json({
      message: `Error processing your question: ${err.message}`,
      error: err.stack,
      layer: err.layer || 'unknown',
      success: false
    });
  }
});

// Test AI query without authentication (for debugging)
router.post('/test-query', async (req, res) => {
  console.log('üîç [LAYER 0 - API Route] Starting AI query test...');

  try {
    const { question } = req.body;
    console.log('üîç [LAYER 0 - API Route] Received question:', question);

    if (!question || question.trim() === '') {
      console.log('üîç [LAYER 0 - API Route] Error: Question is required');
      return res.status(400).json({ message: 'Question is required' });
    }

    // Create mock analysis data for testing
    console.log('üîç [LAYER 1 - Transaction Analyzer] Creating mock analysis data...');
    const analysis = {
      totalExpenses: 3,
      expenses: [
        { date: new Date(), category: 'Food', amount: 250, description: 'Lunch' },
        { date: new Date(), category: 'Transport', amount: 150, description: 'Bus fare' },
        { date: new Date(), category: 'Entertainment', amount: 100, description: 'Movie' }
      ],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: {
        last7Days: 500,
        last30Days: 500,
        last90Days: 500,
        lastYear: 500
      },
      averages: {
        daily: 71,
        weekly: 500,
        monthly: 500
      },
      trends: {
        monthOverMonth: [],
        categoryTrends: {} // Ensure this is properly initialized
      },
      userProfile: {
        income: 2500,
        savings: 2000,
        currency: 'INR',
        goals: ['Save for vacation', 'Build emergency fund'],
        age: 28
      }
    };
    console.log('üîç [LAYER 1 - Transaction Analyzer] Mock analysis created successfully');

    // Layer 2: Apply business rules
    console.log('üîç [LAYER 2 - Rule Engine] Applying business rules...');
    const rules = RuleEngine.applyRules(analysis);
    console.log('üîç [LAYER 2 - Rule Engine] Rules applied successfully');

    // Layer 3: Generate AI advice
    console.log('üîç [LAYER 3 - AI Service] Generating AI advice...');
    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});
    console.log('üîç [LAYER 3 - AI Service] AI advice generated successfully');

    res.json({
      response: aiResult.response,
      model: aiResult.model,
      confidence: aiResult.confidence,
      success: true,
      layer: 'completed'
    });

  } catch (err) {
    console.error('‚ùå [ERROR] AI Query failed at layer:', err.layer || 'unknown');
    console.error('‚ùå [ERROR] Error message:', err.message);
    console.error('‚ùå [ERROR] Stack trace:', err.stack);

    res.status(500).json({
      message: `Error processing your question: ${err.message}`,
      error: err.stack,
      layer: err.layer || 'unknown',
      success: false
    });
  }
});

// Health check endpoint - test Groq API connection
router.get('/test', auth, async (req, res) => {
  try {
    // Test if Groq is available
    const groqAvailable = !!process.env.GROQ_API_KEY;
    res.json({
      groqAvailable,
      message: groqAvailable ? 'Groq AI is configured and ready' : 'Groq API key not found',
      timestamp: new Date()
    });
  } catch (err) {
    res.status(500).json({
      success: false,
      error: err.message,
    });
  }
});

// Test endpoint with NO middleware for debugging
router.post('/test-ai-models', async (req, res) => {
  console.log('üéØ ===== AI TEST REQUEST RECEIVED =====');
  console.log('üéØ Testing AI models with query:', req.body.question);

  try {
    const { question } = req.body;

    // Mock user for testing
    const mockUser = {
      _id: 'test-user-id',
      profile: {
        income: 50000,
        savings: 10000,
        currency: 'INR'
      }
    };

    // Mock analysis data
    const analysis = {
      totalExpenses: 5,
      expenses: [
        { date: new Date(), category: 'Food', amount: 250 },
        { date: new Date(), category: 'Transport', amount: 150 },
        { date: new Date(), category: 'Entertainment', amount: 100 }
      ],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: {
        last7Days: 500,
        last30Days: 500,
        last90Days: 500,
        lastYear: 500
      },
      averages: { daily: 71, weekly: 500, monthly: 500 },
      trends: { monthOverMonth: [], categoryTrends: {} },
      userProfile: mockUser.profile
    };

    // Apply rules
    const rules = RuleEngine.applyRules(analysis);

    // Generate AI response
    console.log('ü§ñ Generating AI response for:', question);
    console.log('ü§ñ advancedAI object exists:', !!advancedAI);
    console.log('ü§ñ advancedAI.generateFinancialAdvice exists:', typeof advancedAI.generateFinancialAdvice);

    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});
    console.log('ü§ñ AI result received:', !!aiResult);

    res.json({
      success: true,
      question,
      response: aiResult.response,
      model: aiResult.model,
      confidence: aiResult.confidence,
      analysis: {
        totalSpent: analysis.totalSpent,
        categories: Object.keys(analysis.categoryBreakdown)
      }
    });

  } catch (error) {
    console.error('‚ùå AI Test Error:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      stack: error.stack
    });
  }
});

// Test endpoint that completely bypasses all middleware
router.post('/test-query-bypass', async (req, res) => {
  console.log('üéØ BYPASS TEST: Received question:', req.body.question);

  try {
    const { question } = req.body;

    if (!question || question.trim() === '') {
      return res.status(400).json({ message: 'Question is required' });
    }

    // Mock user and analysis
    const mockUser = {
      _id: 'test-user',
      profile: { income: 50000, savings: 10000, currency: 'INR' }
    };

    const analysis = {
      totalExpenses: 5,
      expenses: [{ date: new Date(), category: 'Food', amount: 250 }],
      totalSpent: 500,
      categoryBreakdown: { Food: 250, Transport: 150, Entertainment: 100 },
      timeframes: { last7Days: 500, last30Days: 500, last90Days: 500, lastYear: 500 },
      averages: { daily: 71, weekly: 500, monthly: 500 },
      trends: { monthOverMonth: [], categoryTrends: {} },
      userProfile: mockUser.profile
    };

    const rules = {
      alerts: [],
      insights: ['You are spending moderately'],
      recommendations: [{ description: 'Consider cooking at home', priority: 'medium' }],
      summary: { overallHealthScore: 75 }
    };

    console.log('üéØ BYPASS TEST: Calling AI service...');
    const aiResult = await advancedAI.generateFinancialAdvice(question, analysis, rules, {});

    console.log('üéØ BYPASS TEST: AI call completed');
    res.json({
      success: true,
      question,
      response: aiResult.response,
      model: aiResult.model,
      analysis: analysis.categoryBreakdown
    });

  } catch (error) {
    console.error('üéØ BYPASS TEST ERROR:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
      stack: error.stack
    });
  }
});

// Direct test endpoint that bypasses everything
router.post('/direct-test', (req, res) => {
  console.log('üéØ DIRECT TEST ENDPOINT CALLED');
  console.log('Question:', req.body.question);

  const question = req.body.question || '';

  // Return intelligent response based on question
  let response = '';

  if (question.toLowerCase().includes('invest') && question.toLowerCase().includes('fd')) {
    response = `**FDs vs Mutual Funds Investment Guide:**

**For ‚Çπ1000/month investment:**

**Fixed Deposits (FDs):**
‚úÖ **Safety:** Government insured, zero risk
‚úÖ **Returns:** 5-7% annual interest
‚úÖ **Liquidity:** Can break early (penalty applies)
‚úÖ **Best for:** Conservative investors, emergency funds

**Mutual Funds:**
‚úÖ **Growth Potential:** 10-15% historical returns
‚úÖ **Tax Benefits:** ELSS funds offer deductions
‚úÖ **Diversification:** Spread across multiple stocks/bonds
‚úÖ **SIP Advantage:** Rupee cost averaging

**My Recommendation:**
- **60% Mutual Funds** (higher growth)
- **40% FDs** (safety net)
- Start with index funds or balanced advantage funds
- Use SIP for disciplined investing

**Action Steps:**
1. Open demat account
2. Start ‚Çπ600/month SIP in mutual funds
3. Keep ‚Çπ400/month in high-yield FDs`;
  } else {
    response = `I understand you have ‚Çπ1000/month extra income and want investment advice. Could you please specify what type of investment you're considering? For example:
- Fixed Deposits vs Mutual Funds
- Stocks vs Bonds
- Real estate vs Gold
- Emergency fund vs Investments

This will help me provide more targeted advice based on your risk tolerance and goals.`;
  }

  res.json({
    success: true,
    question: question,
    response: response,
    model: 'intelligent-direct-response',
    confidence: 0.9,
    timestamp: new Date()
  });
});

module.exports = router;